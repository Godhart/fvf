# Применение методов формальной верификации

-- TODO: На данном этапе только формируется спецификация осуществления формальной верификации фреймворком, и нет её реализации--

Следующее [описание тестового окружение](../../src/envs/calc_test_mocked_uvm.yaml) 
и [описание теста](../../src/tests/arith/main.py) в функции `tests` для случая `self._uvm == True`
является ранним прототипом такого способа проверки --

Использование фреймворка для осуществления проверок возможно и без применения формалной вериыикации, но именно её 
применение позволит получить ощутимый результат.

## Общий принцип

Для применения методов формальной верификации предлагается следующий прнцип:

Для сущности или группы сущностей даётся формальная спецификация - описание принципов работы в виде набора возможных 
состояний и переходов между ними посредством вызовов определённых методов.

Для каждого из переходов указываются наборы допустимых вариантов аргументов метода, разбитые на множества, например если 
допустим аргумент в виде целого числа из диапазона `[min, max]`, где min < 0 и max > 0, то его для примера можно
разбить на следующие множества: `[min,min]`, `[min,-1]`, `[0,0]`, `[1, max-1]`, `[max,max]` для отдельной проверки 
граничных случаев, а так же для отдельной проверки некоторых специфичных значений, например зачения `0`.

Для каждого из переходов описывается протокол выполнения, т.е. что должно происходить на интерфейсе объекта абстракции 
сущности или группы, т.е. какое взаимодействие с другими сущностями должно происходить (если такое предполагается), 
какие результаты должны быть получены, в какое состояние должны перейти сущности.

В случае, если контроль результата не может быть описан формально, описывается каким образом создать слепок 
состояния сущностей для последующей проверки человеком.

Данное описание передаётся через объект `rules` и будет использоваться объектами `sequencer`, `scoreboard` и `coverage`
для формирования воздействий, оценки коррректности реакции и полноты функционального покрытия проверкой.

-- Формальная спецификация так же может быть использована для анализа наличия недопустимых комбинаций параметров на входе
чтобы повысить покрытие обработки исключительных ситуаций - продумать как это логично использовать, а так же посмотреть,
как это используют в других инструментах формальной верификации --

В одном тестовом окружении может быть один или несколько объектов `sequencer`, формирующих воздействия.
При этом даже если объект `sequencer` будет один, м.б. несколько объектов `coverage` и `scoreboard`, контролирующих 
корректность работы и полноту функционального покрытия различных сущностей.

## Формальная спецификация

Формальная спецификация задаётся через параметры объекта `rules`. Это позволяет абстрагировать спецификацию от формата
её описания и использовать объекты `sequencer`, `probe`, `coverage` и `scoreboard` не изменяя их под тот или иной формат.

На данном этапе предполагается что в первой реализации за основу будут использованы прниципы UVM и используемый в ней 
формат PSL. Методология UVM является сейчас ведущей в проверке кода HDL, что напрямую связано с изначальной целью
разраотки фреймворка и позволит перенять опыт а так же позволит существующим специалистам и использовать имеющиеся 
наработки.

## Обзор объектов формальной верификации

-- TODO: Требует сопоставления с тем, что есть в UVM --
-- TODOC: Информация дана в кратце --

### Rules

Данный объект принимает формальное описание в одном из форматов и формирует данные для других объектов формальной
верификации (`coverage`, `sequencer` и `scoreboard`)

### Coverage

Содержит информацию о возможных состояниях и переходах связанной проверяемой сущности (или группы), и осуществляет учёт
того, какие состояния и переходы уже были покрыты и сколько раз за время проверки. 
-- Так же может формировать дополнительные данные для осуществления контроля цепочек переходов. --

Контроль осуществлятся посредством 
анализа сообщений на 'входе' и 'выходе' объектов абстракции сущностей а так же посредством анализа слепков 
состояния сущностей. С учётом этого в т.ч. рапсполагает информацией о текущем состоянии сущности.\

Для этого используются правила сопоставления получаемой информации о состоянии и работе сущности с 
формальной спецификацией.

Может аккумулировать данные (сохранять и загружать информацию в начале и конца теста), что позволяет разбить выполнение
проверки во времени, распределить её между исполнителями, а так же в принципе разбить её на несколько вариантов 
тестового окружения.

### Scoreboard

Осуществляет контроль корректности выполнения методов (переходов) связанной проверяемой сушностью (или группы) 
посредством анализа принимаемых ими и выдаваемых сообщений связанных с ними обхектами абстракции, а так же посредством 
анализа слепков их состояния.

Для этого используются правила сопоставления получаемой информации о состоянии и работе сущности с 
формальной спецификацией.

В процессе контроля осуществялет пометку переходов, приводящих к ошибкам, и формирует быллы результата проверки.

Может аккумулировать данные (сохранять и загружать информацию в начале и конца теста), что позволяет разбить выполнение
проверки во времени, распределить её между исполнителями, а так же в принципе разбить её на несколько вариантов 
тестового окружения.

При обнаружении ошибки может влиять на выполнение проверки для перевода тестового окружения и проверяемой сущности 
в т.ч. в исходное сосотояние.

### Sequencer

Формирует воздействия для покрытия необходимых состояний и переходов, а так же цепочек переходов. 
Основное преимущество этого объекта проявляется в сочетании с соответсующим объектом `coverage` - получая от него 
текущее состояние, какие переходы и состояния нужно покрыть, и на основе формальной спецификации формирует 
последовательности воздейсвий чтобы обеспечить полное покрытие.

Кроме этого от соовтетвующего объекта `scoreboard` он может получать информацию о переходах, которые приводят к ошибке,
и избегать их при формировании последовательностей воздействий.

В параметрах этого объекта может быть указано минимальное требуемое количество покрытий переходов для завершения
проверки, а так же параметры, влияющие на выбор очередного воздействия и значений аргументов из нескольких возможных
закономерным образом или псевдослучайным, но при этом повторно воспроизводимым.

Кроме это для этого объекта посредством правил могут быть указаны приоритеты проверки состояний и переходы, что позволяет
в начале тестирования проверять самые критичные, а так же показательные случаи (т.н. smoke тестирование) и судить
о целесообразности дальнейшей проверки.

Действия объекта могут координироваться --внешним супервизором--, позволяющим распределить проверку между исполнителями,
а так же в принципе разбить её на несколько этапов с разными вариантами тестового окружения.

В сложных случаях один объект `sequencer` может формировать воздействия для управления другими объектами `sequencer`.

Кроме формирования воздействий на основании информации о покрытии, для воспроизведения случая ошибки формируемая 
во время проверки последовательность воздействий записывается и м.б. воспроизведена этим объектом с определённого места.

### Probe

Данный объект позволяет принимать данные от "зонда" в проверяемой сущности или другой сущности, используемой в тестовом
окружении. Он позволяет принять данные из "внутренних точек" и преобразовывать их к тому или иному интерфейсу (как к 
вызовам так и к ответам), чтобы осуществить контроль соответствия формальной спецификации.

## Применение формальной верификации

-- TODO: --
-- Приведённая информация вкратце описывает идею --

Для осуществления формальной верификации: 

1. Задаётся формальная спецификция одним из следующих образов:
* описывается явно в параметрах объекта `rules` в описании тестового окружения
* в отдельных классах Python, экспортирующих эти правила. Класс, экспортирующий правила указывается в параметре объекта
`rules`.

2. В описании тестового окружения яыным или неявным образом к объекту абстракции проверяемой сущности (или к группе)
добавляются объекты `rules`, `coverage` и `scoreboard` и связываются с ней.

3. В описании тестового окружения добавляется один или несколько объектов `sequencer`, которые будут формировать
воздействия для проведения проверки. Эти объекты могут быть отключаемыи для возможности использования данного
тестового окружения как часть другого окружения но без самостоятельного формирования тестовых воздействий.

Воздействия при формальной верификации формируются исключительно объектами `sequencer` и исключительно на основании
данных объектов `coverage` и `scoreboard`. При запуске проверки можно задать параметры их работы.

## Собираемая информация

* -- TODO: Журнал сообщений --

Во время время выполениня проверки осуществляется журналирование всех передаваемых сообщений. В последствии их можно 
посмотреть в текстовом виде а так же в виде UML диаграммы (данные формируются в формате PlantUML). Журнал может быть 
разбит по фазам проверки - по запускам определённых тестов а так же по воздействиям, формируемым объектами 
типа `sequencer`.

* -- TODO: Слепки состояний --

Помимо сообщений возможен просмотр --слепков состояний-- сущностей, осуществляемых при выполнении тестов явным образом 
или неявно при работе компонентов формальной верификации.
