# Подробное описание объектов фреймворка

## Описание интерфейсов и протоколов

--Этот раздел пока содержит только ключевые мысли, и воможно даже что на данный момент в некотором противоречии --

Описание интерфейсов и протоколов содержится в каталоге `ip`, которрый является пакетом Python

### Общие принципы

Описание каждого интерфейса и соответствующих ему реализаций протокола должно находиться в подкаталоге с именем, 
соответствующим имени интерфейса, который (подкаталог) в свою очередь такж должен являться пакетом Python

В данном пакете должен содержаться модуль Python с именем `definitions`, содержащий --...--

Интерфейс фактически является точкой входа для выполнения того или иного правила протокола

Одному интерфейсу могут соответствовать неколько реализаций протокола. И хотя м.б. несколько реализаций протоколов
 для одного интерфейса, все они фактически должны реализовывать одни правила и обеспечивать один функционал, 
 определяемый интерфейсом. 

В частности разные реализации протокола могут требовать от сущности разные методы и переменные контекста для реализации
 тех или иных вещей, но логика, которую они реализуют должжна быть одинакова, в т.ч. взаимодействие с другими сущностями.

--TODO:-- Вопрос поддержки многошаговых протоколов, в которых нетолько инициатор должен отвечать в ходе выполнения
Вероятно так:
2 набора классов протоколов - один для отвечающего (есть всегда), другой для вызывающего.
Класс вызывающего протокола должен реагировать на ответы, вопрос как лучше это сделать.
Возможно в этом случае необходимо вызывать в первую очередь метод вызывающего протокола (делать запрос), но есть нюанс 
в текущей системе передачи сообщений - не отправляет вызывающему

### Описание интерфейса

Описание самого интерфейса лаклнично и содержит лишь перечень имён методов, а так же имя самого интерфейса
Пример описания интерфейса `stream_io` --(src/ip/stream_io/definitions.py)--:

```python
class StreamIOInterface(PlatformInterfaceCore):
    _base_id = "stream_io"    # Имя интерфейса
    _methods = ("send", "receive")   # Перечень методов
    # На данном этапе реализации требуемая сигнатура методов не указывается, будет добавлено в последствии
    # Methods:  Опционалное описание методов интерфейса в коментариях
    # * send - send data
    #   * args: data - string/bytearray or list of strings/bytearrays
    # * receive - receives data
    #   * args: count - amount of lines to receive
```

### Описание реализации протокола

Описание реализаци протокола содержит реализацию правил протокола для всех методов интерфейса, а так же перечень 
переменных и методов, наличие которых требуется в сущности, которая будет поддерживать этот протокол

Пример описания протокола `stream_io` --(src/ip/stream_io/definitions.py)--:

```python
class StreamIOProtocol(PlatformProtocolCore):
    """
    Implements StreamIO interface
    """
    _default_interface = StreamIOInterface     # Интерфейс, которому соответствует реализация протокола
    _protocol_fields = ("running", )            # Необходимые переменные сущности
    _protocol_methods = ("send", "receive", "reply", "reply_all")  # Необходимые методы сущности

    # Реализация метода send. Имя метода составляется по правилу: '_' + <имя_интерфейса> + '_' + <имя_метода>
    def _stream_io_send(self, context, fake_reply, data):
        # В каждом методе реализации интерфейса есть два обязательных аргумента
        # context - определяет контекст выполнения метода. 
        #   Он содержит:
        #   * имя интерфейса, использованного для приёма сообщения
        #   * имя канала, из которого пришло сообщение и в который нужно отправить ответ
        #   * номер потока (thread) сообщений, из которого пришло сообщение и в который нужно отправить ответ
        #   Подробности про имя канала, потока и принципе вызова метода см. в разделе --...--
        # fake_reply - параметр подстановки "ложного" ответа вместо действительного
        # Прочие аргументы относятся к самому вызываемому методу
        if not self._ensure_running(context, fake_reply):   # В начале всегда следует убелиться, что сущность запущена
            return
        self._notify(context, "Calling send...")    # Послать уведомление в первую очередь о приёме вызова, 
        # чтобы система передачи сообщений отметила эту сущность как активного исполнителя запроса 
        # и ждала завершающего ответа (примечание - активных исполнителей м.б. одновременно несколько)
        self._reply(context,                        # Послать завершающий ответ
                    self._worker.send(context, data),   # В котором результат выполнения метода сущностью
                    fake_reply)                         # или "ложный" ответ если такой был указан в вызове

    # Реализация метода receive. Имя метода составляется по правилу: '_' + <имя_интерфейса> + '_' + <имя_метода>
    def _stream_io_receive(self, context, fake_reply, count=0, timeout=None, decode='UTF-8'):
        if not self._ensure_running(context, fake_reply):
            return
        self._notify(context, "Calling receive...")
        self._reply(context, self._worker.receive(context, count, timeout, decode), fake_reply)
```

### Класс обёртки для упрощения описания поддержки реализации протокола в сущности

Так же в модуле с описанием реализации протокола содержится описание класса-обёртки для этой реализации, 
которое всегда создаётся по одному шаблону.

Пример описания обёртки реализации протокола интерфейса stream_io (src/ip/stream_io/definitions.py):

```python
class StreamIOWrapper(Wrapper):
    """
    Use to map platform's methods and fields into worker, required by SoftwareRunnerProtocol
    """
    _methods = StreamIOProtocol._protocol_methods  # Перечень методов протокола
    _fields = StreamIOProtocol._protocol_fields    # Перечень переменных протокола
```

